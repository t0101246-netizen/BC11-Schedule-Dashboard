<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P6 å°ˆæ¡ˆå…¨æ–¹ä½æ•´åˆæŒ‡æ®ä¸­å¿ƒ</title>
    
    <!-- å¤–éƒ¨å‡½å¼åº« -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js"></script>

    <style>
        /* =========================================
           å…¨åŸŸæ¨£å¼èˆ‡ç³»çµ±åˆ‡æ›å™¨
           ========================================= */
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f0f2f5; color: #333; overflow-x: hidden; }
        
        /* é ‚éƒ¨ç³»çµ±å°èˆªåˆ— */
        #system-nav {
            display: none; /* ç™»å…¥å¾Œé¡¯ç¤º */
            background: #2c3e50;
            padding: 10px 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .sys-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.3);
            color: #ccc;
            padding: 8px 20px;
            margin: 0 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        .sys-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .sys-btn.active { background: #1f77b4; color: white; border-color: #1f77b4; font-weight: bold; box-shadow: 0 0 10px rgba(31,119,180,0.5); }

        /* è¦–åœ–å®¹å™¨æ§åˆ¶ */
        .dashboard-module { display: none; padding: 20px; animation: fadeIn 0.5s; }
        .dashboard-module.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* =========================================
           STYLE SET 1: å°ˆæ¡ˆå…¨æ™¯å„€è¡¨æ¿ (Overview)
           ========================================= */
        /* æ³³é“å¼æ™‚é–“è»¸å®¹å™¨ */
        .swimlane-container {
            display: flex; flex-direction: column; gap: 20px; overflow-x: auto; padding-bottom: 50px;
            background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px;
            max-width: 1600px; margin: 0 auto;
        }
        .timeline-ruler { display: flex; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-left: 150px; position: relative; min-width: 1200px; }
        .month-marker { flex: 1; text-align: left; font-size: 0.8em; color: #999; border-left: 1px dashed #eee; padding-left: 5px; height: 20px; }
        .swimlane-row { display: flex; align-items: center; position: relative; min-width: 1200px; height: 100px; border-bottom: 1px solid #f0f0f0; }
        .swimlane-header { width: 140px; min-width: 140px; font-weight: bold; color: #555; text-align: right; padding-right: 20px; border-right: 3px solid #eee; height: 100%; display: flex; align-items: center; justify-content: flex-end; background: white; z-index: 10; position: sticky; left: 0; }
        .swimlane-track { flex-grow: 1; position: relative; height: 100%; }
        
        /* ä»»å‹™ç¯€é» (Pill) */
        .task-pill { position: absolute; top: 50%; transform: translateY(-50%); background: white; border: 2px solid #1f77b4; color: #1f77b4; padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: bold; cursor: pointer; white-space: nowrap; transition: all 0.2s; z-index: 2; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .task-pill:hover { background: #1f77b4; color: white; z-index: 100; box-shadow: 0 5px 15px rgba(31, 119, 180, 0.3); }
        .task-pill.milestone { background: #d62728; border-color: #d62728; color: white; border-radius: 4px; transform: translateY(-50%) rotate(0deg); }
        .task-pill.milestone:hover { background: #b30000; transform: translateY(-50%) scale(1.1); }

        /* Tooltip (Overview) */
        .exec-tooltip { position: absolute; bottom: 120%; left: 50%; transform: translateX(-50%); width: 300px; background: #333; color: #fff; padding: 15px; border-radius: 8px; font-size: 0.9em; visibility: hidden; opacity: 0; transition: opacity 0.3s; pointer-events: none; text-align: left; white-space: normal; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 999; }
        .exec-tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .task-pill:hover .exec-tooltip { visibility: visible; opacity: 1; }
        .tooltip-title { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; color: #ffcc00; display: block;}
        .tooltip-date { font-size: 0.8em; color: #ccc; margin-bottom: 10px; display: block; border-bottom: 1px solid #555; padding-bottom: 5px;}
        .tooltip-note { line-height: 1.4; }
        .note-tag { color: #ff7f50; font-weight: bold; }

        /* é¡è‰²å®šç¾© */
        .color-admin { border-color: #1f77b4; color: #1f77b4; } .color-admin:hover { background: #1f77b4; color: white; }
        .color-plan { border-color: #17becf; color: #17becf; } .color-plan:hover { background: #17becf; color: white; }
        .color-site { border-color: #2ca02c; color: #2ca02c; } .color-site:hover { background: #2ca02c; color: white; }
        .color-struct { border-color: #ff7f0e; color: #ff7f0e; } .color-struct:hover { background: #ff7f0e; color: white; }

        /* =========================================
           STYLE SET 2: PM æ•´åˆç³»çµ± (PM System)
           ========================================= */
        .pm-container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; max-width: 1800px; margin: 0 auto; width: 100%; box-sizing: border-box; min-height: 85vh;}
        
        .pm-h2 { text-align: center; color: #333; margin-bottom: 5px; font-size: 1.5em; font-weight: bold;}
        .pm-subtitle { text-align: center; color: #666; font-size: 0.9em; margin-bottom: 20px; }

        /* é ‚éƒ¨é ç±¤åˆ‡æ› (Main Tabs) */
        .main-tabs { display: flex; justify-content: center; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab-btn { padding: 15px 30px; cursor: pointer; font-size: 18px; font-weight: bold; color: #666; background: none; border: none; border-bottom: 4px solid transparent; transition: all 0.3s; }
        .tab-btn:hover { color: #1f77b4; background-color: #f9f9f9; }
        .tab-btn.active { color: #1f77b4; border-bottom: 4px solid #1f77b4; }

        /* è¦–åœ–å€åŸŸ */
        .view-section { display: none; animation: fadeIn 0.5s; }
        .view-section.active { display: block; }

        /* æ§åˆ¶é¢æ¿é€šç”¨æ¨£å¼ */
        .control-panel { display: flex; justify-content: space-between; align-items: center; background: #eef; padding: 15px; border-radius: 8px; border-left: 5px solid #1f77b4; margin-bottom: 20px; flex-wrap: wrap; }
        .control-group { display: flex; gap: 10px; align-items: center; margin-right: 20px;}
        .control-label { font-weight: bold; color: #333; margin-right: 5px; }
        
        .sub-nav-buttons button { padding: 8px 16px; cursor: pointer; border: 1px solid #1f77b4; background: white; color: #1f77b4; border-radius: 4px; font-weight: bold; transition: all 0.3s; }
        .sub-nav-buttons button.active { background: #1f77b4; color: white; }
        
        .spec-info { font-size: 0.85em; color: #555; }
        .spec-tag { display: inline-block; background: #ddd; padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-weight: bold; font-size: 0.8em;}
        
        /* åœ–è¡¨å®¹å™¨ */
        #gantt-chart { width: 100%; min-height: 800px; border: 1px solid #eee; }
        #s-curve-chart { width: 100%; height: 400px; border: 1px solid #eee; margin-top: 20px;}
        #network-container { width: 100%; height: 800px; border: 1px solid #ddd; background-color: #fff; border-radius: 4px; }

        /* ç¶²åœ–åœ–ä¾‹ */
        .legend { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; font-size: 0.9em; }
        .legend-item { display: flex; align-items: center; }
        .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
        .dot.critical { background-color: #ffcccc; border: 2px solid #d62728; }
        .dot.normal { background-color: #e6f2ff; border: 2px solid #1f77b4; }
        .dot.milestone { background-color: #fff; border: 2px solid #d62728; transform: rotate(45deg); }
        .dot.month-label { background-color: #eee; border: 1px dashed #666; border-radius: 0; width: 12px; height: 12px;}

        /* =========================================
           å…±ç”¨å…ƒä»¶ï¼šå¯†ç¢¼é®ç½©å±¤
           ========================================= */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }
        .login-box {
            background: white; padding: 40px; border-radius: 12px;
            box-shadow: 0 0 25px rgba(0,0,0,0.7); text-align: center; width: 320px;
        }
        .login-box h3 { margin-top: 0; color: #333; margin-bottom: 20px;}
        .login-box input {
            width: 100%; padding: 12px; margin: 10px 0;
            box-sizing: border-box; border: 2px solid #ddd; border-radius: 6px;
            font-size: 18px; text-align: center; letter-spacing: 2px;
        }
        .login-box button {
            width: 100%; padding: 12px; background-color: #1f77b4;
            color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-top: 10px;
            transition: background 0.3s;
        }
        .login-box button:hover { background-color: #155a8a; }
        #error-msg { color: #d62728; font-size: 0.9em; margin-top: 15px; display: none; font-weight: bold;}

        /* é€šç”¨æ¨™é¡Œ */
        h2 { text-align: center; color: #2c3e50; margin-bottom: 5px; }
        .subtitle { text-align: center; color: #7f8c8d; font-size: 0.9em; margin-bottom: 30px; }
    </style>
</head>
<body>

<!-- 1. çµ±ä¸€å¯†ç¢¼é– -->
<div id="login-overlay">
    <div class="login-box">
        <h3>ğŸ”’ P6 å°ˆæ¡ˆæ•´åˆæŒ‡æ®ä¸­å¿ƒ</h3>
        <input type="password" id="password-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" onkeyup="if(event.keyCode===13) checkPassword()">
        <button onclick="checkPassword()">è§£é–æª¢è¦–</button>
        <div id="error-msg">âš ï¸ å¯†ç¢¼éŒ¯èª¤</div>
    </div>
</div>

<!-- 2. ç³»çµ±å°èˆªåˆ— (ç™»å…¥å¾Œé¡¯ç¤º) -->
<nav id="system-nav">
    <!-- ä¿®æ”¹ï¼šç§»é™¤ã€Œé«˜éšä¸»ç®¡ã€å­—çœ¼ï¼Œæ”¹ç‚ºã€Œå°ˆæ¡ˆå…¨æ™¯å„€è¡¨æ¿ã€ -->
    <button class="sys-btn active" onclick="switchSystemModule('exec')">ğŸ›ï¸ å°ˆæ¡ˆå…¨æ™¯å„€è¡¨æ¿ (Overview)</button>
    <button class="sys-btn" onclick="switchSystemModule('pm')">ğŸ“Š å°ˆæ¡ˆç®¡ç†æ•´åˆç³»çµ± (PM System)</button>
</nav>

<!-- 3. æ¨¡çµ„ A: å°ˆæ¡ˆå…¨æ™¯å„€è¡¨æ¿ (Project Overview) -->
<div id="exec-dashboard-view" class="dashboard-module active">
    <!-- ä¿®æ”¹ï¼šæ¨™é¡Œç§»é™¤ Executive -->
    <h2>P6 å°ˆæ¡ˆåŸ·è¡Œå…¨æ™¯åœ– (Project Overview)</h2>
    <div class="subtitle">ä¾æ“šä½œæ¥­æ€§è³ªåˆ†å±¤é¡¯ç¤º â€¢ æ»‘é¼ æ‡¸åœæŸ¥çœ‹æ³•è¦èˆ‡å‚™è¨»</div>

    <div class="swimlane-container">
        <!-- æ™‚é–“å°º -->
        <div class="timeline-ruler" id="ruler">
            <!-- JS ç”Ÿæˆ -->
        </div>

        <!-- æ³³é“ 1: é—œéµé‡Œç¨‹ç¢‘ -->
        <div class="swimlane-row">
            <div class="swimlane-header" style="color: #d62728; border-right-color: #d62728;">ğŸš© é—œéµé‡Œç¨‹ç¢‘</div>
            <div class="swimlane-track" id="track-milestone"></div>
        </div>

        <!-- æ³³é“ 2: è¡Œæ”¿èˆ‡æ³•è¦ -->
        <div class="swimlane-row">
            <div class="swimlane-header">ğŸ“‘ è¡Œæ”¿/æ³•è¦</div>
            <div class="swimlane-track" id="track-admin"></div>
        </div>

        <!-- æ³³é“ 3: è¨ˆç•«èˆ‡è©¦é©— -->
        <div class="swimlane-row">
            <div class="swimlane-header">ğŸ§ª è¨ˆç•«/è©¦é©—</div>
            <div class="swimlane-track" id="track-plan"></div>
        </div>

        <!-- æ³³é“ 4: ç¾å ´èˆ‡ç®¡ç·š -->
        <div class="swimlane-row">
            <div class="swimlane-header">ğŸš§ ç¾å ´/ç®¡ç·š</div>
            <div class="swimlane-track" id="track-site"></div>
        </div>

        <!-- æ³³é“ 5: åŸºç¤èˆ‡çµæ§‹ -->
        <div class="swimlane-row">
            <div class="swimlane-header">ğŸ—ï¸ åŸºç¤/çµæ§‹</div>
            <div class="swimlane-track" id="track-struct"></div>
        </div>
    </div>
</div>

<!-- 4. æ¨¡çµ„ B: PM æ•´åˆç³»çµ± (PM Integrated System) -->
<div id="pm-system-view" class="dashboard-module">
    <div class="pm-container">
        <h2 class="pm-h2">P6 å°ˆæ¡ˆæ’ç¨‹æ•´åˆå„€è¡¨æ¿</h2>
        <div class="pm-subtitle">æ•´åˆè¦ç¯„ 01103 ç« ï¼šç”˜ç‰¹åœ–ã€S-Curve èˆ‡ æ™‚åºç¶²åœ–</div>

        <!-- é ‚éƒ¨é ç±¤ -->
        <div class="main-tabs">
            <button class="tab-btn active" onclick="switchMainTab('gantt')">ğŸ“… ç”˜ç‰¹åœ–èˆ‡é€²åº¦æ›²ç·š</button>
            <button class="tab-btn" onclick="switchMainTab('network')">ğŸ•¸ï¸ å°ˆæ¡ˆé‚è¼¯ç¶²åœ–</button>
        </div>

        <!-- è¦–åœ– 1: ç”˜ç‰¹åœ–èˆ‡ S-Curve -->
        <div id="view-gantt" class="view-section active">
            <div class="control-panel">
                <div class="control-group">
                    <span class="control-label">é¡¯ç¤ºç¯„åœ:</span>
                    <div class="sub-nav-buttons" id="scope-btns">
                        <button class="active" onclick="setGanttScope('full', this)">ğŸ“Š å®Œæ•´ (Full)</button>
                        <button onclick="setGanttScope('cp', this)">ğŸš© è¦å¾‘ (CPM)</button>
                    </div>
                </div>
                <div class="spec-info">
                    <div><span class="spec-tag">1.4.7 S-Curve</span> é å®šé€²åº¦ç´¯ç©æ›²ç·š</div>
                    <div><span class="spec-tag">3.3.2 Update</span> è³‡æ–™åŸºæº–æ—¥: 2026/04/20</div>
                </div>
            </div>
            <div id="gantt-chart"></div>
            <div id="s-curve-chart"></div>
        </div>

        <!-- è¦–åœ– 2: ç¶²åœ– -->
        <div id="view-network" class="view-section">
            <div class="control-panel">
                <div class="control-group">
                    <span class="control-label">ç¶²åœ–ä½ˆå±€:</span>
                    <div class="sub-nav-buttons" id="net-layout-btns">
                        <button class="active" onclick="setNetworkLayout('hierarchical', this)">ğŸŒ² çµæ§‹ä½ˆå±€ (Hierarchical)</button>
                        <button onclick="setNetworkLayout('timescaled', this)">ğŸ“… æ™‚åºä½ˆå±€ (X-Axis Time)</button>
                    </div>
                </div>
                <div class="legend">
                    <div class="legend-item"><div class="dot critical"></div> é—œéµè·¯å¾‘</div>
                    <div class="legend-item"><div class="dot normal"></div> ä¸€èˆ¬ä½œæ¥­</div>
                    <div class="legend-item"><div class="dot milestone"></div> é‡Œç¨‹ç¢‘</div>
                    <div class="legend-item"><div class="dot month-label"></div> æœˆä»½æ¨™ç±¤</div>
                </div>
            </div>
            <div id="network-container"></div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 0. ç³»çµ±æ ¸å¿ƒæ§åˆ¶ (System Core)
    // ==========================================
    function checkPassword() {
        var input = document.getElementById('password-input').value;
        if (input === '2623') {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('system-nav').style.display = 'block';
            
            // åˆå§‹åŒ–å…©å€‹æ¨¡çµ„
            renderSwimlanes(); // Overview Init
            updateGantt();     // PM Init
        } else {
            document.getElementById('error-msg').style.display = 'block';
        }
    }

    function switchSystemModule(moduleName) {
        // åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.sys-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // åˆ‡æ›è¦–åœ–é¡¯ç¤º
        document.querySelectorAll('.dashboard-module').forEach(div => div.classList.remove('active'));
        
        if (moduleName === 'exec') {
            document.getElementById('exec-dashboard-view').classList.add('active');
        } else if (moduleName === 'pm') {
            document.getElementById('pm-system-view').classList.add('active');
            // ä¿®æ­£ Plotly åœ¨ display:none åˆ‡æ›å¾Œçš„å¯¬åº¦å•é¡Œ
            setTimeout(() => {
                Plotly.relayout('gantt-chart', { autosize: true });
                Plotly.relayout('s-curve-chart', { autosize: true });
            }, 100);
        }
    }

    // ==========================================
    // 1. å°ˆæ¡ˆå…¨æ™¯å„€è¡¨æ¿é‚è¼¯ (Overview Logic)
    // ==========================================
    const execTasks = [
        // é‡Œç¨‹ç¢‘
        {id: "1000", name: "å°ˆæ¡ˆå•Ÿå‹• (NTP)", start: "2026-04-20", group: "milestone", note: "ã€å¥‘ç´„ä¸»é‡Œç¨‹ç¢‘ã€‘ï¼šå·¥æœŸèµ·ç®—æ—¥ã€‚"},
        {id: "3035", name: "å¯¦è³ªé–‹å·¥", start: "2026-06-20", group: "milestone", note: "ã€å¼·åˆ¶é‡Œç¨‹ç¢‘ã€‘ï¼šå±è©•ã€ç’°ä¿ã€è·¯è­‰çš†å®Œæˆå¾Œï¼Œå§‹å¾—é–‹å·¥ã€‚"},
        {id: "8000", name: "å¢©æŸ±ç¬¬ä¸€å‡å±¤", start: "2027-01-23", group: "milestone", note: "ã€å°ˆæ¡ˆç›®æ¨™é”æˆã€‘ï¼šæ¯”åŸå®šè¨ˆç•«å¤§å¹…æå‰ã€‚"},
        // è¡Œæ”¿
        {id: "1005", name: "ä¿éšªæŠ•ä¿", start: "2026-04-21", group: "admin", note: "ã€å¥‘ç´„ç¬¬13æ¢ã€‘ï¼šæœªæŠ•ä¿ä¸å¾—é–‹å·¥ã€‚"},
        {id: "1010", name: "è¨ˆç•«æé€", start: "2026-04-21", group: "admin", note: "ã€è¶•å·¥ç­–ç•¥ã€‘ï¼šæ•´é«”/å“è³ª/å®‰è¡›/BIMä¸€æ¬¡æ€§æ›è™Ÿã€‚"},
        {id: "1020", name: "å±è©•å¯©æŸ¥", start: "2026-06-11", group: "admin", note: "ã€è·å®‰æ³•ã€‘ï¼šçµ•å°è¦å¾‘ï¼Œæœªæ ¸å®šä¸å¾—é–‹å·¥ã€‚"},
        {id: "1040", name: "ç’°ä¿è¨±å¯", start: "2026-05-25", group: "admin", note: "ã€ç’°ä¿æ³•è¦ã€‘ï¼šå«é€•æµå»¢æ°´ã€ç©ºæ±¡ã€‚æœªæ ¸å®šå‰ä¸å¾—æ¶è¨­åœç±¬ã€‚"},
        {id: "1050", name: "äº¤ç¶­æ ¸å®š", start: "2026-06-22", group: "admin", note: "ã€è¡Œæ”¿è¦å¾‘ã€‘ï¼šå”èª¿äº¤é€šå±€å¬é–‹é“å®‰æœƒå ±ã€‚"},
        {id: "1060", name: "è·¯è­‰å–å¾—", start: "2026-06-15", group: "admin", note: "ã€å¹³è¡Œä½œæ¥­ã€‘ï¼šäº¤ç¶­å¯©æŸ¥å¾Œæ®µå…ˆè¡Œæ›ä»¶ã€‚"},
        // è¨ˆç•«
        {id: "2005", name: "ææ–™é€å¯©", start: "2026-05-07", group: "plan", note: "ã€æºé ­ç®¡ç†ã€‘ï¼šç¢ºèªé æ‹Œå» èˆ‡é‹¼ç­‹å» ç”¢èƒ½ã€‚"},
        {id: "2010", name: "é…æ¯”è©¦æ‹Œ", start: "2026-05-30", group: "plan", note: "ã€å“è³ªè¨ˆç•«ã€‘ï¼šé‡å°æ¨å¸½ã€å¢©æŸ±é€²è¡Œå» å…§è©¦æ‹Œã€‚"},
        {id: "2020", name: "é…æ¯”æ ¸å®š", start: "2026-07-16", group: "plan", note: "ã€ç›£é€ å¯©æŸ¥ã€‘ï¼šå¼·åº¦å ±å‘Šåˆæ ¼å¾Œæ–¹å¯æ ¸å®šã€‚"},
        {id: "2030", name: "å·¨ç©è©¦é©—", start: "2026-08-08", group: "plan", note: "ã€å¹³è¡Œä½œæ¥­ã€‘ï¼šå¯¦è³ªé–‹å·¥å¾ŒåŒæ­¥é€²è¡Œã€‚"},
        // ç¾å ´
        {id: "3030", name: "æ–½å·¥åœç±¬", start: "2026-06-22", group: "site", note: "ã€äº¤ç¶­è¨ˆç•«ã€‘ï¼šä¾æ ¸å®šç¯„åœä½ˆè¨­ã€‚"},
        {id: "3010", name: "æ¤æ ½ç§»æ¤", start: "2026-06-22", group: "site", note: "ã€å¹³è¡Œä½œæ¥­ã€‘ï¼šåœç±¬æ¶è¨­åŒæ™‚é€²è¡Œã€‚"},
        {id: "3070", name: "è‡¨æ™‚æ°´é›»", start: "2026-06-22", group: "site", note: "ã€å·¥åœ°è¡Œæ”¿ã€‘ï¼šç”³è«‹è‡¨æ™‚æ°´é›»åŠçµ„åˆå±‹è¨±å¯ã€‚"},
        {id: "3040", name: "æ§‹å°ä¾¿é“", start: "2026-06-27", group: "site", note: "ã€å¹³è¡Œä½œæ¥­ã€‘ï¼šåœç±¬å®Œæˆå‰æ®µå¾Œé€²å ´ã€‚"},
        {id: "4010", name: "ç®¡ç·šè©¦æŒ–", start: "2026-07-03", group: "site", note: "ã€å¹³è¡Œä½œæ¥­ã€‘ï¼šç¢ºèªæ¨ä½ç„¡éšœç¤™ã€‚"},
        {id: "4020", name: "ç®¡ç·šé·ç§»", start: "2026-07-08", group: "site", note: "ã€å¹³è¡Œä½œæ¥­ã€‘ï¼šæ¶è¨­è‡¨æ™‚æ¶ç©ºç·šã€‚"},
        // çµæ§‹
        {id: "5005", name: "åœ°è³ªæ”¹è‰¯", start: "2026-07-31", group: "struct", note: "ã€é—œéµè¦å¾‘ã€‘ï¼šJSG æ©Ÿå…·å…¨é¢é€²å ´ã€‚"},
        {id: "5010", name: "è©¦æ¨æ–½ä½œ", start: "2026-08-12", group: "struct", note: "ã€å¹³è¡Œä½œæ¥­ã€‘ï¼šJSG å®Œæˆç¬¬ä¸€åˆ†å€å¾Œé€²å ´ã€‚"},
        {id: "5020", name: "å…¨å¥—ç®¡åŸºæ¨", start: "2026-09-28", group: "struct", note: "ã€è³‡æºæ¥çºŒã€‘ï¼šè©¦æ¨é€šéå¾Œå…¨é¢å±•é–‹ã€‚"},
        {id: "5040", name: "é é‘„æ¢å ´", start: "2026-09-28", group: "struct", note: "ã€é•·äº¤æœŸç®¡æ§ã€‘ï¼šèˆ‡åŸºç¤å·¥ç¨‹å¹³è¡Œé€²è¡Œã€‚"},
        {id: "6010", name: "æ¨å¸½é–‹æŒ–", start: "2026-11-19", group: "struct", note: "ã€å¹³è¡Œä½œæ¥­ã€‘ï¼šåŸºæ¨é¤Šè­·å®Œæˆå€åŸŸå…ˆè¡Œé–‹æŒ–ã€‚"},
        {id: "6070", name: "æ¨å¸½æ¾†ç½®", start: "2026-12-25", group: "struct", note: "ã€é‡Œç¨‹ç¢‘ã€‘ï¼šéœ€ç¢ºèªæ¨¡å‹è©¦é©—åˆæ ¼ã€‚"},
        {id: "7020", name: "å¢©æŸ±é‹¼ç­‹", start: "2027-01-08", group: "struct", note: "ã€çµæ§‹æ–½å·¥ã€‘ï¼šéŠœæ¥æ¨å¸½é ç•™ç­‹ã€‚"},
        {id: "7060", name: "å¢©æŸ±æ¾†ç½®", start: "2027-01-23", group: "struct", note: "ã€æ–½å·¥è¦åŠƒã€‘ï¼šåˆ†å±¤æ¾†ç½®ã€‚"}
    ];

    function renderSwimlanes() {
        // 1. è¨ˆç®—æ™‚é–“ç¯„åœèˆ‡æ¯”ä¾‹
        const startDate = new Date("2026-04-01");
        const endDate = new Date("2027-02-28");
        const totalDays = (endDate - startDate) / (1000 * 60 * 60 * 24);
        const containerWidth = 1600; // ç¸½å¯¬åº¦ px
        const pxPerDay = containerWidth / totalDays;

        // 2. ç¹ªè£½æ™‚é–“å°º (Ruler)
        const ruler = document.getElementById('ruler');
        ruler.innerHTML = ''; // æ¸…ç©ºé‡ç¹ª
        let currDate = new Date(startDate);
        while (currDate <= endDate) {
            const marker = document.createElement('div');
            marker.className = 'month-marker';
            marker.innerText = currDate.toISOString().slice(0, 7); // YYYY-MM
            ruler.appendChild(marker);
            currDate.setMonth(currDate.getMonth() + 1);
        }

        // 3. ç¹ªè£½ä»»å‹™
        execTasks.forEach(task => {
            const taskDate = new Date(task.start);
            const offsetDays = (taskDate - startDate) / (1000 * 60 * 60 * 24);
            const leftPos = offsetDays * pxPerDay;

            const pill = document.createElement('div');
            pill.className = `task-pill color-${task.group}`;
            if (task.group === 'milestone') pill.classList.add('milestone');
            
            pill.style.left = `${leftPos}px`;
            pill.innerHTML = `
                ${task.name} <span style="font-size:0.8em; opacity:0.8">(${task.start.slice(5)})</span>
                <div class="exec-tooltip">
                    <span class="tooltip-title">${task.name}</span>
                    <span class="tooltip-date">ğŸ“… é–‹å§‹æ—¥æœŸ: ${task.start}</span>
                    <div class="tooltip-note">${formatNote(task.note)}</div>
                </div>
            `;

            // åˆ†é…åˆ°å°æ‡‰è»Œé“
            let trackId = `track-${task.group}`;
            if (task.group === 'site' || task.group === 'pipe') trackId = 'track-site';
            
            const track = document.getElementById(trackId);
            if (track) track.appendChild(pill);
        });
    }

    function formatNote(note) {
        if (note.includes("ã€")) {
            const parts = note.split("ã€‘ï¼š");
            if (parts.length > 1) {
                return `<span class="note-tag">${parts[0]}ã€‘ï¼š</span>${parts[1]}`;
            }
        }
        return note;
    }

    // ==========================================
    // 2. PM æ•´åˆç³»çµ±é‚è¼¯ (PM System Logic)
    // ==========================================
    var fullTasks = [
        {id: "1000", name: "1000 å°ˆæ¡ˆå•Ÿå‹• (NTP)", start: "2026-04-20", finish: "2026-04-20", group: "1.è¡Œæ”¿æ³•è¦", color: "#d62728", duration: 0},
        {id: "1.1", name: "1.1 è¾¦ç†: å·¥ç¨‹ä¿éšªå–®æŠ•ä¿", start: "2026-04-21", finish: "2026-04-28", group: "1.è¡Œæ”¿æ³•è¦", color: "#1f77b4", duration: 7},
        {id: "1.2", name: "1.2 æé€: æ•´é«”/å“è³ª/å®‰è¡›è¨ˆç•«", start: "2026-04-21", finish: "2026-05-06", group: "1.è¡Œæ”¿æ³•è¦", color: "#1f77b4", duration: 14},
        {id: "1.3", name: "1.3 å¯©æŸ¥: å±è©• (ä¸é¡)", start: "2026-04-21", finish: "2026-06-11", group: "1.è¡Œæ”¿æ³•è¦", color: "#1f77b4", duration: 45},
        {id: "1.4", name: "1.4 èª¿æŸ¥: é„°æˆ¿ç¾æ³é‘‘å®š", start: "2026-04-21", finish: "2026-06-11", group: "1.è¡Œæ”¿æ³•è¦", color: "#17becf", duration: 45},
        {id: "1.5", name: "1.5 è¨±å¯: ç’°ä¿è¨±å¯", start: "2026-04-21", finish: "2026-05-25", group: "1.è¡Œæ”¿æ³•è¦", color: "#1f77b4", duration: 30},
        {id: "1.6", name: "1.6 æ ¸å®š: äº¤ç¶­è¨ˆç•«", start: "2026-05-07", finish: "2026-06-22", group: "1.è¡Œæ”¿æ³•è¦", color: "#9467bd", duration: 40},
        {id: "1.7", name: "1.7 å–å¾—: é“è·¯æŒ–æ˜è¨±å¯", start: "2026-05-30", finish: "2026-06-15", group: "1.è¡Œæ”¿æ³•è¦", color: "#d62728", duration: 14},
        {id: "2.1", name: "2.1 é€å¯©: ææ–™èˆ‡ä¾›æ‡‰å•†", start: "2026-05-07", finish: "2026-05-29", group: "2.è¨ˆç•«è©¦é©—", color: "#17becf", duration: 20},
        {id: "2.2", name: "2.2 è©¦æ‹Œ: æ··å‡åœŸé…æ¯”", start: "2026-05-30", finish: "2026-07-15", group: "2.è¨ˆç•«è©¦é©—", color: "#17becf", duration: 40},
        {id: "2.3", name: "2.3 æ ¸å®š: é…æ¯”è¨­è¨ˆå ±å‘Š", start: "2026-07-16", finish: "2026-08-07", group: "2.è¨ˆç•«è©¦é©—", color: "#17becf", duration: 20},
        {id: "2.4", name: "2.4 æ–½ä½œ: å·¨ç©æ··å‡åœŸè©¦é©—", start: "2026-08-08", finish: "2026-09-29", group: "2.è¨ˆç•«è©¦é©—", color: "#17becf", duration: 45},
        {id: "3.1", name: "3.1 é‡Œç¨‹ç¢‘: å¯¦è³ªé–‹å·¥", start: "2026-06-20", finish: "2026-06-20", group: "é‡Œç¨‹ç¢‘", color: "#d62728", duration: 0},
        {id: "3.2", name: "3.2 æ¶è¨­: æ–½å·¥åœç±¬", start: "2026-06-22", finish: "2026-07-14", group: "3.å ´åœ°æº–å‚™", color: "#2ca02c", duration: 20},
        {id: "3.3", name: "3.3 æ–½ä½œ: æ¤æ ½ç§»æ¤", start: "2026-06-22", finish: "2026-07-14", group: "3.å ´åœ°æº–å‚™", color: "#2ca02c", duration: 20},
        {id: "3.4", name: "3.4 é‹ªè¨­: æ§‹å°èˆ‡ä¾¿é“", start: "2026-06-27", finish: "2026-07-14", group: "3.å ´åœ°æº–å‚™", color: "#2ca02c", duration: 15},
        {id: "3.5", name: "3.5 å®‰è£: ç›£æ¸¬å„€å™¨", start: "2026-06-27", finish: "2026-07-08", group: "3.å ´åœ°æº–å‚™", color: "#2ca02c", duration: 10},
        {id: "3.6", name: "3.6 æ–½ä½œ: æ¸¬é‡æ”¾æ¨£", start: "2026-06-22", finish: "2026-06-29", group: "3.å ´åœ°æº–å‚™", color: "#2ca02c", duration: 7},
        {id: "3.7", name: "3.7 è¨­ç½®: å·¥å‹™æ‰€/æ°´é›»", start: "2026-06-22", finish: "2026-07-25", group: "3.å ´åœ°æº–å‚™", color: "#2ca02c", duration: 30},
        {id: "4.1", name: "4.1 è©¦æŒ–: åŸºæ¨é»ä½", start: "2026-07-03", finish: "2026-07-14", group: "4.ç®¡ç·šè™•ç†", color: "#8c564b", duration: 10},
        {id: "4.2", name: "4.2 é·ç§»: è‡¨æ™‚ä¾›é›»", start: "2026-07-08", finish: "2026-07-30", group: "4.ç®¡ç·šè™•ç†", color: "#8c564b", duration: 20},
        {id: "5.1", name: "5.1 æ–½ä½œ: åœ°è³ªæ”¹è‰¯ (JSG)", start: "2026-07-31", finish: "2026-09-26", group: "5.åŸºç¤å·¥ç¨‹", color: "#2ca02c", duration: 50},
        {id: "5.2", name: "5.2 æ–½ä½œ: è©¦æ¨ (Test Pile)", start: "2026-08-12", finish: "2026-09-03", group: "5.åŸºç¤å·¥ç¨‹", color: "#2ca02c", duration: 20},
        {id: "5.3", name: "5.3 æª¢æ¸¬: è©¦æ¨è¼‰é‡è©¦é©—", start: "2026-09-04", finish: "2026-09-23", group: "5.åŸºç¤å·¥ç¨‹", color: "#2ca02c", duration: 17},
        {id: "5.4", name: "5.4 æ–½ä½œ: å…¨å¥—ç®¡åŸºæ¨", start: "2026-09-28", finish: "2026-11-12", group: "5.åŸºç¤å·¥ç¨‹", color: "#2ca02c", duration: 40},
        {id: "5.5", name: "5.5 æª¢æ¸¬: æ¨åº•çŒæ¼¿", start: "2026-11-07", finish: "2026-11-23", group: "5.åŸºç¤å·¥ç¨‹", color: "#2ca02c", duration: 15},
        {id: "5.6", name: "5.6 ç±Œè¨­: é é‘„æ¢å ´ (Float)", start: "2026-09-28", finish: "2027-02-13", group: "5.åŸºç¤å·¥ç¨‹", color: "#7f7f7f", duration: 120},
        {id: "6.1", name: "6.1 æ–½ä½œ: æ¨å¸½é–‹æŒ–", start: "2026-11-19", finish: "2026-12-05", group: "6.æ¨å¸½å·¥ç¨‹", color: "#ff7f0e", duration: 15},
        {id: "6.2", name: "6.2 æ–½ä½œ: PC æ¾†ç½®", start: "2026-12-01", finish: "2026-12-11", group: "6.æ¨å¸½å·¥ç¨‹", color: "#ff7f0e", duration: 10},
        {id: "6.3", name: "6.3 ç¶ç´®: æ¨å¸½é‹¼ç­‹", start: "2026-12-07", finish: "2026-12-22", group: "6.æ¨å¸½å·¥ç¨‹", color: "#ff7f0e", duration: 14},
        {id: "6.4", name: "6.4 ç•Œé¢: æ¥åœ°ç¶²", start: "2026-12-12", finish: "2026-12-17", group: "6.æ¨å¸½å·¥ç¨‹", color: "#ff7f0e", duration: 5},
        {id: "6.5", name: "6.5 çµ„ç«‹: æ¨å¸½æ¨¡æ¿", start: "2026-12-18", finish: "2026-12-23", group: "6.æ¨å¸½å·¥ç¨‹", color: "#ff7f0e", duration: 5},
        {id: "6.7", name: "6.7 æ¾†ç½®: æ¨å¸½æ··å‡åœŸ", start: "2026-12-25", finish: "2026-12-25", group: "6.æ¨å¸½å·¥ç¨‹", color: "#ff7f0e", duration: 1},
        {id: "7.1", name: "7.1 æ­è¨­: é‡å‹æ–½å·¥æ¶", start: "2027-01-02", finish: "2027-01-07", group: "7.å¢©æŸ±å·¥ç¨‹", color: "#ff7f0e", duration: 5},
        {id: "7.2", name: "7.2 ç¶ç´®: å¢©æŸ±é‹¼ç­‹", start: "2027-01-08", finish: "2027-01-19", group: "7.å¢©æŸ±å·¥ç¨‹", color: "#ff7f0e", duration: 10},
        {id: "7.4", name: "7.4 çµ„ç«‹: å¢©æŸ±é‹¼æ¨¡", start: "2027-01-16", finish: "2027-01-21", group: "7.å¢©æŸ±å·¥ç¨‹", color: "#ff7f0e", duration: 5},
        {id: "7.6", name: "7.6 æ¾†ç½®: å¢©æŸ±æ··å‡åœŸ", start: "2027-01-23", finish: "2027-01-23", group: "7.å¢©æŸ±å·¥ç¨‹", color: "#ff7f0e", duration: 1},
        {id: "8000", name: "8 é‡Œç¨‹ç¢‘: é”æˆå¢©æŸ±ç¬¬ä¸€å‡å±¤", start: "2027-01-23", finish: "2027-01-23", group: "é‡Œç¨‹ç¢‘", color: "#d62728", duration: 0}
    ];

    var cpTasks = fullTasks.filter(t => 
        ["1000", "1.2", "1.6", "1.7", "3.1", "3.2", "3.4", "4.1", "4.2", "5.1", "5.2", "5.3", "5.4", "5.5", "6.1", "6.2", "6.3", "6.4", "6.5", "6.7", "7.1", "7.2", "7.4", "7.6", "8000"].includes(t.id)
    );

    // ç¶²åœ–ç”¨æ•¸æ“š (Nodes)
    const networkNodesData = fullTasks.map(t => {
        let group = 'normal';
        let shape = 'box';
        if (cpTasks.find(cp => cp.id === t.id)) group = 'critical';
        if (t.duration === 0) { group = 'milestone'; shape = 'diamond'; }
        
        return {
            id: t.id,
            label: `<b>${t.name}</b>\n${t.duration}d\n${t.start}`,
            group: group,
            shape: shape,
            start: t.start // ç”¨æ–¼æ™‚åºæ’åˆ—
        };
    });

    // ç¶²åœ–ç”¨æ•¸æ“š (Edges)
    const networkEdgesData = [
        { from: "1000", to: "1.1" }, { from: "1000", to: "1.2" }, { from: "1000", to: "1.3" }, { from: "1000", to: "1.4" }, { from: "1000", to: "1.5" },
        { from: "1.2", to: "1.6" }, { from: "1.2", to: "2.1" },
        { from: "1.6", to: "1.7", label: "SS+20" },
        { from: "1.3", to: "3.1" }, { from: "1.5", to: "3.1" }, { from: "1.7", to: "3.1" },
        { from: "2.1", to: "2.2" }, { from: "2.2", to: "2.3" }, { from: "2.3", to: "2.4" },
        { from: "3.1", to: "3.2" }, { from: "3.1", to: "3.3" }, { from: "3.1", to: "3.6" }, { from: "3.1", to: "3.7" },
        { from: "3.2", to: "3.4", label: "SS+5" }, { from: "3.2", to: "3.5", label: "SS+5" },
        { from: "3.4", to: "4.1", label: "SS+5" },
        { from: "4.1", to: "4.2", label: "SS+4" },
        { from: "4.2", to: "5.1" },
        { from: "5.1", to: "5.2", label: "SS+10" }, { from: "5.1", to: "5.6" }, { from: "5.1", to: "5.4" },
        { from: "5.2", to: "5.3" },
        { from: "5.3", to: "5.4" },
        { from: "5.4", to: "5.5", label: "SS+35" },
        { from: "5.5", to: "6.1", label: "SS+10" },
        { from: "6.1", to: "6.2", label: "SS+10" },
        { from: "6.2", to: "6.3", label: "SS+5" },
        { from: "6.3", to: "6.4", label: "SS+5" },
        { from: "6.4", to: "6.5" },
        { from: "6.5", to: "6.7" }, { from: "2.4", to: "6.7" },
        { from: "6.7", to: "7.1", label: "FS+7" },
        { from: "7.1", to: "7.2" },
        { from: "7.2", to: "7.4", label: "SS+7" },
        { from: "7.4", to: "7.5" },
        { from: "7.5", to: "7.6" },
        { from: "7.6", to: "8000" }
    ];

    let networkInstance = null;
    let currentGanttScope = 'full';
    let currentNetworkLayout = 'hierarchical';

    function switchMainTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        document.querySelectorAll('.view-section').forEach(div => div.classList.remove('active'));
        document.getElementById('view-' + tabName).classList.add('active');

        if (tabName === 'gantt') {
            Plotly.relayout('gantt-chart', { autosize: true });
            Plotly.relayout('s-curve-chart', { autosize: true });
        } else if (tabName === 'network') {
            if (!networkInstance) {
                setTimeout(drawNetwork, 100);
            }
        }
    }

    // --- ç”˜ç‰¹åœ–æ§åˆ¶ ---
    function setGanttScope(scope, btn) {
        currentGanttScope = scope;
        document.querySelectorAll('#scope-btns button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        updateGantt();
    }

    function updateGantt() {
        let dataSet = (currentGanttScope === 'full') ? fullTasks : cpTasks;
        renderGantt(dataSet);
        renderSCurve(dataSet);
    }

    function renderGantt(dataSet) {
        var tasks = JSON.parse(JSON.stringify(dataSet)).reverse();
        var xData = tasks.map(t => new Date(t.finish) - new Date(t.start) + 86400000);
        var baseData = tasks.map(t => t.start);
        var colorData = tasks.map(t => t.color);
        var yData = tasks.map(t => t.name);

        var trace = {
            type: 'bar',
            orientation: 'h',
            x: xData,
            base: baseData,
            y: yData,
            marker: { color: colorData, opacity: 0.8, line: { width: 1, color: '#333' } },
            hovertext: tasks.map(t => `<b>${t.name}</b><br>å·¥æœŸ: ${t.duration}å¤©<br>${t.start} ~ ${t.finish}`),
            hoverinfo: 'text'
        };

        var layout = {
            title: 'å°ˆæ¡ˆé€²åº¦ç”˜ç‰¹åœ– (Gantt Chart)',
            height: 1200,
            xaxis: { title: 'æ—¥æœŸ', type: 'date', tickformat: '%Y-%m', side: 'top', gridcolor: '#eee' },
            yaxis: { automargin: true, tickfont: {size: 11} },
            margin: {l: 300, r: 50, t: 80, b: 50}
        };

        Plotly.newPlot('gantt-chart', [trace], layout);
    }

    function renderSCurve(tasks) {
        let sData = generateSCurveData(tasks);
        var trace = {
            x: sData.dates,
            y: sData.plannedProgress,
            mode: 'lines+markers',
            name: 'é å®šé€²åº¦ (Planned)',
            line: { shape: 'spline', color: '#1f77b4', width: 3 }
        };
        var layout = {
            title: 'é å®šé€²åº¦ S-Curve (ä¾è¦ç¯„ 1.4.7)',
            xaxis: { title: 'æ—¥æœŸ', type: 'date', tickformat: '%Y-%m', gridcolor: '#eee' },
            yaxis: { title: 'ç´¯ç©å®Œæˆç™¾åˆ†æ¯” (%)', range: [0, 105], gridcolor: '#eee' },
            margin: {l: 60, r: 50, t: 50, b: 50},
            showlegend: true
        };
        Plotly.newPlot('s-curve-chart', [trace], layout);
    }

    function generateSCurveData(tasks) {
        let minDate = new Date("2026-04-20");
        let maxDate = new Date("2027-02-13");
        let dates = [];
        let plannedProgress = [];
        let totalWeight = tasks.reduce((acc, t) => acc + (t.duration || 1), 0);

        for (let d = new Date(minDate); d <= maxDate; d.setDate(d.getDate() + 7)) {
            let currentDate = new Date(d);
            dates.push(currentDate.toISOString().split('T')[0]);
            let currentWeight = 0;
            tasks.forEach(t => {
                let start = new Date(t.start);
                let finish = new Date(t.finish);
                if (currentDate >= finish) {
                    currentWeight += (t.duration || 1);
                } else if (currentDate > start) {
                    let daysPassed = (currentDate - start) / (1000 * 60 * 60 * 24);
                    currentWeight += daysPassed;
                }
            });
            let percent = (currentWeight / totalWeight) * 100;
            plannedProgress.push(percent > 100 ? 100 : percent);
        }
        return { dates, plannedProgress };
    }

    // --- ç¶²åœ–æ§åˆ¶ ---
    function setNetworkLayout(layout, btn) {
        currentNetworkLayout = layout;
        document.querySelectorAll('#net-layout-btns button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        drawNetwork();
    }

    // è¨ˆç®—æ™‚åºä½ˆå±€åº§æ¨™ (Xè»¸ç‚ºæ™‚é–“)
    function getTimeScaledPositions(nodes) {
        const positions = {};
        const monthGroups = {};
        
        // 1. åˆ†çµ„
        nodes.forEach(node => {
            if (!node.start) return;
            const month = node.start.substring(0, 7); // YYYY-MM
            if (!monthGroups[month]) monthGroups[month] = [];
            monthGroups[month].push(node.id);
        });

        // 2. æ’åºæœˆä»½
        const sortedMonths = Object.keys(monthGroups).sort();
        
        // 3. è¨ˆç®—åº§æ¨™ (Xè»¸ç‚ºæ™‚é–“ï¼ŒYè»¸ç‚ºè©²æœˆå…§çš„æ’åˆ—)
        const xSpacing = 250; // æœˆä»½é–“è·
        const ySpacing = 120; // åŒæœˆä½œæ¥­é–“è·
        
        // é¡å¤–ç”Ÿæˆæœˆä»½æ¨™ç±¤ç¯€é»
        const labelNodes = [];

        sortedMonths.forEach((month, xIndex) => {
            const ids = monthGroups[month];
            const colHeight = ids.length * ySpacing;
            const startY = -(colHeight / 2);
            
            // æœˆä»½æ¨™ç±¤ (æ”¾åœ¨ä¸Šæ–¹)
            labelNodes.push({
                id: `label-${month}`,
                label: `<b>${month}</b>`,
                x: xIndex * xSpacing,
                y: -400, // å›ºå®šåœ¨ä¸Šæ–¹
                shape: 'box',
                color: { background: '#eee', border: '#666' },
                font: { multi: 'html', size: 16 },
                physics: false,
                group: 'month-label'
            });

            ids.forEach((id, yIndex) => {
                positions[id] = {
                    x: xIndex * xSpacing,
                    y: startY + (yIndex * ySpacing)
                };
            });
        });

        return { positions, labelNodes };
    }

    function drawNetwork() {
        if (typeof vis === 'undefined') return;

        // æº–å‚™ç¯€é»æ•¸æ“š
        let displayNodes = JSON.parse(JSON.stringify(networkNodesData));
        let layoutOptions = {};
        let physicsEnabled = false;

        if (currentNetworkLayout === 'hierarchical') {
            // çµæ§‹ä½ˆå±€ï¼šä½¿ç”¨ Vis.js å…§å»ºå±¤æ¬¡
            layoutOptions = {
                hierarchical: {
                    direction: 'LR',
                    sortMethod: 'directed',
                    levelSeparation: 220,
                    nodeSpacing: 150,
                    treeSpacing: 200,
                    blockShifting: true,
                    edgeMinimization: true,
                    parentCentralization: true,
                    shakeTowards: 'roots'
                }
            };
        } else {
            // æ™‚åºä½ˆå±€ï¼šæ‰‹å‹•è¨ˆç®—åº§æ¨™ (Xè»¸æ™‚é–“)
            const { positions, labelNodes } = getTimeScaledPositions(displayNodes);
            
            // åˆä½µæœˆä»½æ¨™ç±¤ç¯€é»
            displayNodes = displayNodes.concat(labelNodes);

            // å¥—ç”¨åº§æ¨™
            displayNodes.forEach(node => {
                if (positions[node.id]) {
                    node.x = positions[node.id].x;
                    node.y = positions[node.id].y;
                }
            });
            
            layoutOptions = { hierarchical: false }; // é—œé–‰å±¤æ¬¡
            physicsEnabled = false; // é—œé–‰ç‰©ç†å¼•æ“ä»¥å›ºå®šä½ç½®
        }

        // æ¨£å¼è¨­å®š
        const visNodes = new vis.DataSet(displayNodes.map(t => {
            let bgColor = '#e6f2ff';
            let borderColor = '#1f77b4';
            if (t.group === 'critical') { bgColor = '#ffcccc'; borderColor = '#d62728'; }
            else if (t.group === 'milestone') { bgColor = '#fff'; borderColor = '#d62728'; }
            else if (t.group === 'month-label') { bgColor = '#eee'; borderColor = '#666'; }

            return {
                id: t.id,
                label: t.label,
                shape: t.shape || 'box',
                x: t.x,
                y: t.y,
                color: { background: bgColor, border: borderColor, highlight: { background: '#ffffcc', border: '#333' } },
                font: { multi: 'html', size: 14, color: '#333' },
                margin: 10,
                borderWidth: 2,
                fixed: (currentNetworkLayout === 'timescaled') // æ™‚åºæ¨¡å¼ä¸‹å›ºå®šç¯€é»
            };
        }));

        const visEdges = new vis.DataSet(networkEdgesData.map(e => ({
            from: e.from,
            to: e.to,
            label: e.label || '',
            arrows: 'to',
            color: { color: '#666', highlight: '#000' },
            font: { align: 'top', size: 11, background: 'white' },
            smooth: { type: 'cubicBezier', roundness: 0.5 }
        })));

        const container = document.getElementById('network-container');
        const data = { nodes: visNodes, edges: visEdges };
        
        const options = {
            layout: layoutOptions,
            physics: { enabled: physicsEnabled },
            interaction: { dragNodes: true, zoomView: true, dragView: true }
        };

        networkInstance = new vis.Network(container, data, options);
    }
</script>

</body>
</html>